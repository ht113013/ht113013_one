<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç­ç´šä¸€ç•ªè³</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.2/dist/confetti.browser.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: #1a202c; /* æ·±ç°è‰²èƒŒæ™¯ */
            color: #e2e8f0; /* æ·ºç°è‰²æ–‡å­— */
        }
        .prize-card {
            background-color: #2d3748;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            border: 2px solid transparent;
        }
        .prize-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 15px rgba(0, 0, 0, 0.2);
        }
        .prize-A { border-color: #f6e05e; } /* é‡‘è‰² */
        .prize-B { border-color: #f56565; } /* ç´…è‰² */
        .prize-C { border-color: #48bb78; } /* ç¶ è‰² */
        .prize-D { border-color: #4299e1; } /* è—è‰² */
        .prize-E { border-color: #a0aec0; } /* ç°è‰² */

        .btn {
            transition: all 0.3s ease;
        }

        .btn-primary {
            background-color: #4299e1;
            color: white;
        }
        .btn-primary:hover {
            background-color: #2b6cb0;
        }

        .btn-danger {
            background-color: #f56565;
            color: white;
        }
        .btn-danger:hover {
            background-color: #c53030;
        }
        
        .modal-backdrop {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 50;
        }
        .modal-content {
            background-color: #2d3748;
            padding: 2rem;
            border-radius: 12px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.3);
            max-width: 90%;
            width: 500px;
        }

        .loader {
            border: 5px solid #f3f3f3;
            border-top: 5px solid #4299e1;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div id="app" class="container mx-auto p-4 md:p-8">

        <!-- Loading Overlay -->
        <div id="loading-overlay" class="modal-backdrop hidden">
            <div class="loader"></div>
        </div>

        <!-- Login Screen -->
        <div id="login-screen">
            <div class="max-w-md mx-auto bg-gray-800 p-8 rounded-xl shadow-lg mt-16">
                <h1 class="text-3xl font-bold text-center mb-6 text-white">æ•™å¸«ç™»å…¥</h1>
                <form id="login-form">
                    <div class="mb-4">
                        <label for="username" class="block mb-2 text-sm font-medium text-gray-300">å¸³è™Ÿ</label>
                        <input type="text" id="username" class="w-full bg-gray-700 border border-gray-600 rounded-lg p-2.5 text-white focus:ring-blue-500 focus:border-blue-500" required>
                    </div>
                    <div class="mb-6">
                        <label for="password" class="block mb-2 text-sm font-medium text-gray-300">å¯†ç¢¼</label>
                        <input type="password" id="password" class="w-full bg-gray-700 border border-gray-600 rounded-lg p-2.5 text-white focus:ring-blue-500 focus:border-blue-500" required>
                    </div>
                    <button type="submit" class="w-full btn btn-primary font-bold py-2 px-4 rounded-lg">ç™»å…¥</button>
                    <p class="text-center mt-4 text-gray-400">å­¸ç”Ÿè«‹ç›´æ¥é»æ“Šä¸‹æ–¹æŒ‰éˆ•</p>
                    <button type="button" id="student-view-btn" class="w-full btn bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg mt-2">é€²å…¥å­¸ç”Ÿæ¨¡å¼</button>
                </form>
            </div>
        </div>

        <!-- Class Selection Screen -->
        <div id="class-selection-screen" class="hidden">
             <div class="max-w-md mx-auto bg-gray-800 p-8 rounded-xl shadow-lg mt-16">
                <h1 class="text-3xl font-bold text-center mb-2 text-white">è«‹é¸æ“‡ç­ç´š</h1>
                <p class="text-center text-gray-400 mb-6">è€å¸«å¯åœ¨æ­¤æ–°å¢æˆ–åˆªé™¤ç­ç´š</p>
                <button id="manage-classes-btn" class="w-full mb-6 btn bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded-lg hidden">ç®¡ç†ç­ç´š</button>
                <div id="class-list" class="flex flex-col space-y-2">
                    <!-- Class buttons will be inserted here -->
                </div>
                <button type="button" id="back-to-login-btn" class="w-full btn bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg mt-6">è¿”å›ç™»å…¥</button>
             </div>
        </div>
        
        <!-- Main Content -->
        <div id="main-content" class="hidden">
            <header class="flex flex-wrap justify-between items-center mb-8">
                <div>
                    <h1 class="text-4xl font-bold text-white">ç­ç´šä¸€ç•ªè³</h1>
                    <p id="class-name-display" class="text-xl text-blue-300"></p>
                </div>
                <div id="teacher-controls" class="hidden flex items-center space-x-2 mt-4 md:mt-0">
                    <button id="reset-btn" class="btn btn-danger font-bold py-2 px-4 rounded-lg">é‡ç½®çå“</button>
                    <button id="logout-btn" class="btn bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg">ç™»å‡º</button>
                </div>
                 <div id="student-back-controls" class="hidden mt-4 md:mt-0">
                    <button id="student-back-btn" class="btn bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg">è¿”å›é¸æ“‡ç­ç´š</button>
                </div>
            </header>

            <!-- Prize Section -->
            <div id="teacher-draw-section" class="text-center mb-8 hidden">
                <h2 class="text-2xl font-semibold mb-4 text-white">æŠ½çå€</h2>
                <button id="draw-btn" class="btn btn-primary text-xl font-bold py-3 px-8 rounded-full shadow-lg transform hover:scale-105">é–‹å§‹æŠ½çï¼</button>
            </div>

            <h2 class="text-2xl font-semibold mb-4 text-white">å‰©é¤˜çå“</h2>
            <div id="prize-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-8">
                <!-- Prize cards will be inserted here -->
            </div>

            <!-- History Section -->
            <h2 class="text-2xl font-semibold mb-4 text-white">æŠ½çç´€éŒ„</h2>
            <div class="bg-gray-800 rounded-xl shadow-lg p-6">
                <div class="overflow-x-auto">
                    <table class="w-full text-left">
                        <thead class="text-gray-400">
                            <tr>
                                <th class="p-3">æ™‚é–“</th>
                                <th class="p-3">å¾—çè€…</th>
                                <th class="p-3">çå“</th>
                            </tr>
                        </thead>
                        <tbody id="history-log">
                           <!-- History rows will be inserted here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Prize Result Modal -->
        <div id="prize-modal" class="modal-backdrop hidden">
            <div id="prize-modal-content" class="modal-content text-center relative">
                <h2 class="text-2xl font-bold mb-4">æ­å–œï¼æŠ½ä¸­äº†...</h2>
                <div id="prize-result" class="text-4xl font-bold my-8"></div>
                <button id="close-prize-modal" class="btn btn-primary font-bold py-2 px-6 rounded-lg">å¤ªæ£’äº†ï¼</button>
            </div>
        </div>
        
        <!-- Manage Classes Modal -->
        <div id="manage-classes-modal" class="modal-backdrop hidden">
            <div class="modal-content">
                <h2 class="text-2xl font-bold mb-6">ç®¡ç†ç­ç´š</h2>
                <div class="mb-6">
                    <h3 class="text-lg font-semibold mb-2">æ–°å¢ç­ç´š</h3>
                    <div class="flex">
                        <input type="text" id="new-class-name" placeholder="è«‹è¼¸å…¥æ–°ç­ç´šåç¨±" class="w-full bg-gray-700 border border-gray-600 rounded-l-lg p-2.5 text-white focus:ring-blue-500 focus:border-blue-500">
                        <button id="add-class-btn" class="btn bg-green-600 hover:bg-green-700 text-white font-bold p-2.5 rounded-r-lg">æ–°å¢</button>
                    </div>
                </div>
                 <div class="mb-4">
                    <h3 class="text-lg font-semibold mb-2">åˆªé™¤ç­ç´š</h3>
                    <div id="delete-class-list" class="space-y-2">
                        <!-- Deletable class list will be here -->
                    </div>
                </div>
                <button id="close-manage-modal" class="w-full mt-6 btn bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg">é—œé–‰</button>
            </div>
        </div>

        <!-- Generic Alert/Confirm Modal -->
        <div id="custom-modal" class="modal-backdrop hidden">
            <div class="modal-content">
                <h2 id="custom-modal-title" class="text-2xl font-bold mb-4"></h2>
                <p id="custom-modal-message" class="text-gray-300 mb-6"></p>
                <div id="custom-modal-buttons" class="flex justify-end space-x-4">
                    <!-- Buttons will be injected here -->
                </div>
            </div>
        </div>

    </div>

    <script>
        // --- è¨­å®š ---
        // !!! é‡è¦ï¼šè«‹å°‡æ­¤è™•çš„ URL æ›¿æ›ç‚ºæ‚¨éƒ¨ç½² Google Apps Script å¾Œå¾—åˆ°çš„ç¶²å€ !!!
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxLff9LbLW5sWe0AQDxpmtjubvsw7hZ8RI_h19elwUOZRi4NMlQV62v114Fbx75Pby1ow/exec';

        const prizeDetails = {
            'A': { name: 'ğŸ§ Aè³ï¼šå°ç±³ç„¡ç·šè€³æ©Ÿ', total: 1, class: 'prize-A' },
            'B': { name: 'ğŸ— Bè³ï¼šè‚¯å¾·åŸºç´™åŒ…é›å¥—é¤', total: 5, class: 'prize-B' },
            'C': { name: 'ğŸ¥¤ Cè³ï¼šæ‰‹æ–é£²æ–™(ç„¡ç³–)', total: 12, class: 'prize-C' },
            'D': { name: 'ğŸ’¯ Dè³ï¼šä½œæ¥­æ»¿åˆ†', total: 15, class: 'prize-D' },
            'E': { name: 'ğŸ¬ Eè³ï¼šé›¶é£Ÿä¸€ä»½', total: 30, class: 'prize-E' },
        };
        
        // --- DOM å…ƒç´  ---
        const app = document.getElementById('app');
        const loadingOverlay = document.getElementById('loading-overlay');
        const loginScreen = document.getElementById('login-screen');
        const classSelectionScreen = document.getElementById('class-selection-screen');
        const mainContent = document.getElementById('main-content');
        
        // --- ç‹€æ…‹ç®¡ç† ---
        let state = {
            isLoggedIn: false,
            sessionToken: null, // *** å®‰å…¨æ€§æ›´æ–°ï¼šå„²å­˜è‡¨æ™‚é€šè¡Œè­‰ ***
            currentClass: null,
            classes: [],
            prizes: {},
            history: [],
        };
        
        // --- Custom Modal Functions ---
        function showAlert(message, title = 'é€šçŸ¥') {
            const modal = document.getElementById('custom-modal');
            document.getElementById('custom-modal-title').textContent = title;
            document.getElementById('custom-modal-message').innerHTML = `<p>${message}</p>`;
            const buttonsDiv = document.getElementById('custom-modal-buttons');
            buttonsDiv.innerHTML = `<button id="custom-modal-ok" class="btn btn-primary font-bold py-2 px-6 rounded-lg">ç¢ºå®š</button>`;
            
            modal.classList.remove('hidden');

            const okBtn = document.getElementById('custom-modal-ok');
            const newOkBtn = okBtn.cloneNode(true);
            okBtn.parentNode.replaceChild(newOkBtn, okBtn);
            
            newOkBtn.addEventListener('click', () => {
                modal.classList.add('hidden');
            });
        }

        function showConfirm(message, title, onConfirm) {
            const modal = document.getElementById('custom-modal');
            document.getElementById('custom-modal-title').textContent = title;
            document.getElementById('custom-modal-message').innerHTML = `<p>${message}</p>`;
            const buttonsDiv = document.getElementById('custom-modal-buttons');
            buttonsDiv.innerHTML = `
                <button id="custom-modal-cancel" class="btn bg-gray-600 hover:bg-gray-700 font-bold py-2 px-6 rounded-lg">å–æ¶ˆ</button>
                <button id="custom-modal-confirm" class="btn btn-danger font-bold py-2 px-6 rounded-lg">ç¢ºå®š</button>
            `;
            
            modal.classList.remove('hidden');

            const confirmBtn = document.getElementById('custom-modal-confirm');
            const cancelBtn = document.getElementById('custom-modal-cancel');
            
            const newConfirmBtn = confirmBtn.cloneNode(true);
            const newCancelBtn = cancelBtn.cloneNode(true);
            confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);
            cancelBtn.parentNode.replaceChild(newCancelBtn, cancelBtn);

            newConfirmBtn.addEventListener('click', () => {
                modal.classList.add('hidden');
                if (onConfirm) onConfirm(true);
            });
            
            newCancelBtn.addEventListener('click', () => {
                modal.classList.add('hidden');
                if (onConfirm) onConfirm(false);
            });
        }

        function showPrompt(message, title, onComplete) {
            const modal = document.getElementById('custom-modal');
            document.getElementById('custom-modal-title').textContent = title;
            document.getElementById('custom-modal-message').innerHTML = `
                <p class="mb-4">${message}</p>
                <input type="text" id="custom-modal-input" class="w-full bg-gray-700 border border-gray-600 rounded-lg p-2.5 text-white focus:ring-blue-500 focus:border-blue-500" placeholder="è«‹åœ¨æ­¤è¼¸å…¥...">`;
            
            const buttonsDiv = document.getElementById('custom-modal-buttons');
            buttonsDiv.innerHTML = `
                <button id="custom-modal-cancel" class="btn bg-gray-600 hover:bg-gray-700 font-bold py-2 px-6 rounded-lg">å–æ¶ˆ</button>
                <button id="custom-modal-confirm" class="btn btn-primary font-bold py-2 px-6 rounded-lg">ç¢ºå®š</button>
            `;
            
            modal.classList.remove('hidden');
            const inputField = document.getElementById('custom-modal-input');
            inputField.focus();

            const confirmBtn = document.getElementById('custom-modal-confirm');
            const cancelBtn = document.getElementById('custom-modal-cancel');
            
            const newConfirmBtn = confirmBtn.cloneNode(true);
            const newCancelBtn = cancelBtn.cloneNode(true);
            confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);
            cancelBtn.parentNode.replaceChild(newCancelBtn, cancelBtn);

            newConfirmBtn.addEventListener('click', () => {
                modal.classList.add('hidden');
                if (onComplete) onComplete(inputField.value);
            });
            
            newCancelBtn.addEventListener('click', () => {
                modal.classList.add('hidden');
                if (onComplete) onComplete(null); // Return null if cancelled
            });
        }
        
        // --- API å‘¼å« ---
        // *** å®‰å…¨æ€§æ›´æ–°ï¼šä¿®æ”¹ apiCall ä»¥æ”¯æ´ POSTï¼Œä¸¦å€åˆ†å…¬é–‹å’Œéœ€é©—è­‰çš„æ“ä½œ ***
        async function apiCall(action, params = {}, method = 'GET') {
            if (!SCRIPT_URL) {
                showAlert('éŒ¯èª¤ï¼šGoogle Apps Script ç¶²å€æœªè¨­å®šï¼è«‹åœ¨ index.html ä¸­å¡«å¯« SCRIPT_URL è®Šæ•¸ã€‚', 'è¨­å®šéŒ¯èª¤');
                return { success: false, error: 'SCRIPT_URL not set' };
            }
            toggleLoading(true);
            
            try {
                let response;
                if (method === 'GET') {
                    const url = new URL(SCRIPT_URL);
                    url.searchParams.append('action', action);
                    Object.keys(params).forEach(key => url.searchParams.append(key, params[key]));
                    response = await fetch(url);
                } else { // POST
                    // éœ€é©—è­‰çš„æ“ä½œï¼Œè‡ªå‹•åŠ å…¥ token
                    if (state.sessionToken) {
                        params.token = state.sessionToken;
                    }
                    response = await fetch(SCRIPT_URL, {
                        method: 'POST',
                        redirect: 'follow',
                        headers: { 'Content-Type': 'text/plain;charset=utf-8' }, // Apps Script é™åˆ¶
                        body: JSON.stringify({ action, params })
                    });
                }
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const result = await response.json();
                
                // å¾Œç«¯å›å ± token å¤±æ•ˆï¼Œå¼·åˆ¶ç™»å‡º
                if (result.success === false && result.error === 'Authentication failed') {
                    handleLogout(true); // å‚³å…¥ true è¡¨ç¤ºæ˜¯å›  token å¤±æ•ˆè€Œç™»å‡º
                }

                return result;
            } catch (error) {
                console.error('API Call Error:', error);
                showAlert(`èˆ‡ä¼ºæœå™¨é€šè¨Šå¤±æ•—: ${error.message}`, 'é€£ç·šéŒ¯èª¤');
                return { success: false, error: error.message };
            } finally {
                toggleLoading(false);
            }
        }
        
        // --- è¦–åœ–åˆ‡æ› ---
        function showView(view) {
            loginScreen.classList.add('hidden');
            classSelectionScreen.classList.add('hidden');
            mainContent.classList.add('hidden');
            document.getElementById(view).classList.remove('hidden');
        }

        function toggleLoading(show) {
            loadingOverlay.classList.toggle('hidden', !show);
        }

        // --- æ¸²æŸ“å‡½å¼ ---
        function renderPrizes() {
            const prizeGrid = document.getElementById('prize-grid');
            prizeGrid.innerHTML = '';
            Object.entries(prizeDetails).forEach(([key, detail]) => {
                const remaining = state.prizes[key] ?? 0;
                const card = document.createElement('div');
                card.className = `prize-card p-6 flex justify-between items-center ${detail.class}`;
                
                const contentDiv = document.createElement('div');
                const title = document.createElement('h3');
                title.className = 'text-xl font-bold';
                title.textContent = detail.name; // ä½¿ç”¨ textContent é˜²ç¯„ XSS
                const desc = document.createElement('p');
                desc.className = 'text-gray-400';
                desc.textContent = `ç¸½æ•¸: ${detail.total}`;
                contentDiv.append(title, desc);

                const countDiv = document.createElement('div');
                countDiv.className = 'text-3xl font-bold';
                const countSpan = document.createElement('span');
                countSpan.textContent = remaining;
                countDiv.appendChild(countSpan);

                card.append(contentDiv, countDiv);
                prizeGrid.appendChild(card);
            });
        }
        
        // *** å®‰å…¨æ€§æ›´æ–°ï¼šæ”¹ç”¨ document.createElement å’Œ textContent é˜²ç¯„ XSS ***
        function renderHistory() {
            const historyLog = document.getElementById('history-log');
            historyLog.innerHTML = ''; // Clear previous content
            if (state.history.length === 0) {
                 const row = historyLog.insertRow();
                 const cell = row.insertCell();
                 cell.colSpan = 3;
                 cell.className = 'text-center p-4 text-gray-500';
                 cell.textContent = 'ç›®å‰æ²’æœ‰æŠ½çç´€éŒ„';
                 return;
            }
            state.history.forEach(item => {
                const row = historyLog.insertRow();
                row.className = 'border-b border-gray-700';
                
                const cellTime = row.insertCell();
                cellTime.className = 'p-3 text-gray-400';
                cellTime.textContent = new Date(item.timestamp).toLocaleString();
                
                const cellName = row.insertCell();
                cellName.className = 'p-3 font-semibold';
                cellName.textContent = item.studentName; // å®‰å…¨åœ°è¨­å®šå­¸ç”Ÿå§“å
                
                const cellPrize = row.insertCell();
                cellPrize.className = 'p-3';
                cellPrize.textContent = prizeDetails[item.prize] ? prizeDetails[item.prize].name : 'æœªçŸ¥çå“'; // å®‰å…¨åœ°è¨­å®šçå“åç¨±
            });
        }

        function renderClassSelection() {
            const classList = document.getElementById('class-list');
            classList.innerHTML = '';
            if (state.classes.length === 0 && state.isLoggedIn) {
                 classList.innerHTML = '<p class="text-center text-gray-400 my-4">ç›®å‰æ²’æœ‰ç­ç´šï¼Œè«‹é»æ“Šä¸Šæ–¹ã€Œç®¡ç†ç­ç´šã€ä¾†æ–°å¢ã€‚</p>';
            } else if (state.classes.length === 0) {
                 classList.innerHTML = '<p class="text-center text-gray-400 my-4">ç›®å‰è€å¸«å°šæœªå»ºç«‹ä»»ä½•ç­ç´šã€‚</p>';
            }
            state.classes.forEach(className => {
                const btn = document.createElement('button');
                btn.className = 'w-full btn btn-primary font-bold py-3 px-4 rounded-lg';
                btn.textContent = className;
                btn.onclick = () => selectClass(className);
                classList.appendChild(btn);
            });
        }
        
        // --- é‚è¼¯è™•ç† ---
        // *** å®‰å…¨æ€§æ›´æ–°ï¼šæ”¹ç”¨ POST ç™»å…¥ä¸¦å–å¾— token ***
        async function handleLogin(username, password) {
            const result = await apiCall('login', { username, password }, 'POST');
            if (result.success && result.data.token) {
                state.isLoggedIn = true;
                state.sessionToken = result.data.token;
                sessionStorage.setItem('sessionToken', result.data.token);
                await loadClasses();
                showView('class-selection-screen');
                document.getElementById('manage-classes-btn').classList.remove('hidden');
            } else {
                showAlert(`ç™»å…¥å¤±æ•—: ${result.error}`, 'ç™»å…¥éŒ¯èª¤');
            }
        }
        
        function handleLogout(isTokenExpired = false) {
            if (isTokenExpired) {
                showAlert('é–’ç½®éä¹…æˆ–æ†‘è­‰å·²å¤±æ•ˆï¼Œè«‹é‡æ–°ç™»å…¥ã€‚', 'é€£ç·šé€¾æ™‚');
            }
            state.isLoggedIn = false;
            state.sessionToken = null;
            state.currentClass = null;
            sessionStorage.removeItem('sessionToken');
            showView('login-screen');
            document.getElementById('teacher-controls').classList.add('hidden');
            document.getElementById('teacher-draw-section').classList.add('hidden');
            document.getElementById('student-back-controls').classList.add('hidden');
        }
        
        // å…¬é–‹è³‡æ–™ï¼Œä½¿ç”¨ GET
        async function loadClasses() {
            const result = await apiCall('getClasses', {}, 'GET');
            if (result.success) {
                state.classes = result.data;
                renderClassSelection();
            }
        }
        
        // å…¬é–‹è³‡æ–™ï¼Œä½¿ç”¨ GET
        async function selectClass(className) {
            const result = await apiCall('getClassData', { className }, 'GET');
            if (result.success) {
                state.currentClass = className;
                state.prizes = result.data.prizes;
                state.history = result.data.history;
                
                document.getElementById('class-name-display').textContent = `ç•¶å‰ç­ç´š: ${className}`;
                renderPrizes();
                renderHistory();
                showView('main-content');
                
                if (state.isLoggedIn) {
                    document.getElementById('teacher-controls').classList.remove('hidden');
                    document.getElementById('teacher-draw-section').classList.remove('hidden');
                    document.getElementById('student-back-controls').classList.add('hidden');
                } else {
                     document.getElementById('student-back-controls').classList.remove('hidden');
                }
            } else {
                showAlert(`è¼‰å…¥ç­ç´šè³‡æ–™å¤±æ•—: ${result.error}`, 'è³‡æ–™éŒ¯èª¤');
            }
        }
        
        async function handleDraw() {
            showPrompt('è«‹è¼¸å…¥å¾—çå­¸ç”Ÿå§“åï¼š', 'é€²è¡ŒæŠ½ç', (studentName) => {
                if (studentName === null) return;
                if (!studentName || studentName.trim() === '') {
                    showAlert("å­¸ç”Ÿå§“åä¸å¯ç‚ºç©ºï¼", "è¼¸å…¥éŒ¯èª¤");
                    return;
                }
                performDraw(studentName.trim());
            });
        }
        
        // éœ€é©—è­‰æ“ä½œï¼Œä½¿ç”¨ POST
        async function performDraw(studentName) {
            const result = await apiCall('drawPrize', { className: state.currentClass, studentName: studentName }, 'POST');

            if (result.success && result.data.prize) {
                const prizeWon = result.data.prize;
                state.prizes = result.data.prizes;
                state.history = result.data.history;
                renderPrizes();
                renderHistory();
                showPrizeModal(prizeWon);
            } else {
                showAlert(`æŠ½çå¤±æ•—: ${result.error || 'çå“å·²æŠ½å®Œ'}`, 'æŠ½çå¤±æ•—');
            }
        }

        function showPrizeModal(prize) {
            const modal = document.getElementById('prize-modal');
            const resultDiv = document.getElementById('prize-result');
            resultDiv.textContent = prizeDetails[prize].name;
            resultDiv.className = `text-4xl font-bold my-8 ${prizeDetails[prize].class.replace('prize-', 'text-').replace('a0aec0', 'gray-300')}`;
            modal.classList.remove('hidden');
            
            confetti({ particleCount: 150, spread: 90, origin: { y: 0.6 } });
        }
        
        // éœ€é©—è­‰æ“ä½œï¼Œä½¿ç”¨ POST
        async function handleReset() {
            showConfirm(`ç¢ºå®šè¦é‡ç½®ç­ç´šã€Œ${state.currentClass}ã€çš„æ‰€æœ‰çå“å’ŒæŠ½çç´€éŒ„å—ï¼Ÿæ­¤æ“ä½œç„¡æ³•å¾©åŸï¼`, 'é‡ç½®ç¢ºèª', async (confirmed) => {
                if(confirmed) {
                    const result = await apiCall('resetClass', { className: state.currentClass }, 'POST');
                    if (result.success) {
                        showAlert('é‡ç½®æˆåŠŸï¼');
                        await selectClass(state.currentClass);
                    } else {
                        showAlert(`é‡ç½®å¤±æ•—: ${result.error}`, 'æ“ä½œå¤±æ•—');
                    }
                }
            });
        }
        
        // --- åˆå§‹åŒ– & äº‹ä»¶ç›£è½ ---
        document.addEventListener('DOMContentLoaded', () => {
            const savedToken = sessionStorage.getItem('sessionToken');
            if(savedToken){
                state.isLoggedIn = true;
                state.sessionToken = savedToken;
                loadClasses();
                showView('class-selection-screen');
                document.getElementById('manage-classes-btn').classList.remove('hidden');
            }

            document.getElementById('login-form').addEventListener('submit', (e) => {
                e.preventDefault();
                const username = document.getElementById('username').value;
                const password = document.getElementById('password').value;
                handleLogin(username, password);
            });
            
            document.getElementById('student-view-btn').addEventListener('click', async () => {
                state.isLoggedIn = false;
                state.sessionToken = null;
                sessionStorage.removeItem('sessionToken');
                await loadClasses();
                showView('class-selection-screen');
                document.getElementById('manage-classes-btn').classList.add('hidden');
            });

            document.getElementById('back-to-login-btn').addEventListener('click', () => {
                showView('login-screen');
            });
            
            document.getElementById('student-back-btn').addEventListener('click', () => {
                state.currentClass = null;
                showView('class-selection-screen');
            });

            document.getElementById('logout-btn').addEventListener('click', () => handleLogout(false));
            document.getElementById('draw-btn').addEventListener('click', handleDraw);
            document.getElementById('reset-btn').addEventListener('click', handleReset);
            
            document.getElementById('close-prize-modal').addEventListener('click', () => {
                 document.getElementById('prize-modal').classList.add('hidden');
            });
            
            const manageModal = document.getElementById('manage-classes-modal');
            
            document.getElementById('manage-classes-btn').addEventListener('click', () => {
                renderDeleteClassList();
                manageModal.classList.remove('hidden');
            });

            document.getElementById('close-manage-modal').addEventListener('click', () => {
                manageModal.classList.add('hidden');
            });
            
            // éœ€é©—è­‰æ“ä½œï¼Œä½¿ç”¨ POST
            document.getElementById('add-class-btn').addEventListener('click', async () => {
                const newClassNameInput = document.getElementById('new-class-name');
                const newClassName = newClassNameInput.value.trim();
                if (!newClassName) {
                    showAlert('ç­ç´šåç¨±ä¸å¯ç‚ºç©ºï¼', 'è¼¸å…¥éŒ¯èª¤');
                    return;
                }

                const result = await apiCall('manageClass', { task: 'add', className: newClassName }, 'POST');
                if (result.success) {
                    showAlert(`ç­ç´šã€Œ${newClassName}ã€æ–°å¢æˆåŠŸï¼`);
                    newClassNameInput.value = '';
                    state.classes.push(newClassName);
                    renderDeleteClassList();
                    renderClassSelection();
                } else {
                    showAlert(`æ–°å¢å¤±æ•—: ${result.error}`, 'æ“ä½œå¤±æ•—');
                }
            });
            
            // *** å®‰å…¨æ€§æ›´æ–°ï¼šæ”¹ç”¨ document.createElement å’Œ textContent é˜²ç¯„ XSS ***
            function renderDeleteClassList() {
                const listDiv = document.getElementById('delete-class-list');
                listDiv.innerHTML = '';
                if(state.classes.length === 0){
                    listDiv.innerHTML = '<p class="text-gray-500">ç›®å‰æ²’æœ‰ç­ç´šå¯ä¾›åˆªé™¤ã€‚</p>';
                    return;
                }
                state.classes.forEach(className => {
                    const item = document.createElement('div');
                    item.className = 'flex justify-between items-center bg-gray-700 p-2 rounded-lg';
                    
                    const nameSpan = document.createElement('span');
                    nameSpan.textContent = className; // å®‰å…¨åœ°è¨­å®šç­ç´šåç¨±
                    
                    const deleteBtn = document.createElement('button');
                    deleteBtn.className = 'btn btn-danger text-xs py-1 px-2 rounded';
                    deleteBtn.textContent = 'åˆªé™¤';
                    deleteBtn.dataset.class = className;
                    deleteBtn.addEventListener('click', handleDeleteClass);

                    item.append(nameSpan, deleteBtn);
                    listDiv.appendChild(item);
                });
            }
            
            // éœ€é©—è­‰æ“ä½œï¼Œä½¿ç”¨ POST
            async function handleDeleteClass(event) {
                const className = event.target.dataset.class;
                showConfirm(`ç¢ºå®šè¦åˆªé™¤ç­ç´šã€Œ${className}ã€å—ï¼Ÿæ‰€æœ‰ç›¸é—œè³‡æ–™å°‡æœƒéºå¤±ï¼`, 'åˆªé™¤ç¢ºèª', async (confirmed) => {
                    if(confirmed){
                        const result = await apiCall('manageClass', { task: 'delete', className }, 'POST');
                        if (result.success) {
                            showAlert(`ç­ç´šã€Œ${className}ã€å·²åˆªé™¤ã€‚`);
                            state.classes = state.classes.filter(c => c !== className);
                            if(state.currentClass === className){
                               handleLogout();
                            }
                            renderDeleteClassList();
                            renderClassSelection();
                        } else {
                            showAlert(`åˆªé™¤å¤±æ•—: ${result.error}`, 'æ“ä½œå¤±æ•—');
                        }
                    }
                });
            }
        });
    </script>
</body>
</html>

